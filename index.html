
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

    <meta charset="UTF-8">
    <title>Luna Cards</title>
    <script language="javascript" type="text/javascript" src="js/web3.js-0.20.6/web3.min.js"></script>

    <script language="javascript" type="text/javascript" src="tradingcards.abi.js"></script>
</head>

<body>

<div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
    <h5 class="my-0 mr-md-auto font-weight-normal">Luna Cards</h5>
    <nav class="my-2 my-md-0 mr-md-3">
        <a class="p-2 text-dark" href="https://github.com/cballantyne/cardz">Github</a>
        <a class="p-2 text-dark" href="#">WTF is this?</a>
    </nav>
</div>

<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <!--<h1 class="display-4">Pricing</h1>-->
    <p class="lead" id="cardSetDescription"></p>

    <p class="lead"><a href="#" id="submitCardSetAddressShow">[select different CardSet]</a></p>

    <p class="lead" id="cardSetAddressForm">

        <input type="text" id="cardSetAddress">
        <input type="submit" id="submitCardSetAddress" value="Set">
        <input type="submit" id="submitCardSetAddressCancel" value="Cancel">

    </p>


    <p class="lead" id="unownedCardsCount">

    </p>
    <a href="#" id="buyRandomCard">Buy Random Card</a>
</div>

<div class="container">
    <div id="cards" class="row mb-3 text-center">

        <!-- cards are displayed here -->
    </div>

    <footer class="pt-4 my-md-5 pt-md-5 border-top">

    </footer>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

<script>
    var tradingCards;
    var userAccount;
    const defaultTradingCardsAddress = '0xa98b3ca48aa50364f7b30d68f8d5153409b5dc1e';
    if (localStorage.getItem('cardSetContract') === null) {
        localStorage.setItem('cardSetContract', defaultTradingCardsAddress);
    }
    let tradingCardsAddress = localStorage.getItem('cardSetContract');

    const promisify = (func, ...args) =>
        new Promise((resolve, reject) =>
            func(...args, (err, value) =>
                (err ? reject(err) : resolve(value))
            )
        );

    function startApp() {
        console.log("starting app...");
        console.log(tradingcardsAbi);

        $("#cardSetAddressForm").hide();

        const tradingCardsContract = web3js.eth.contract(tradingcardsAbi);
        tradingCards = tradingCardsContract.at(tradingCardsAddress);


        // localStorage.setItem('cardSetContract', '0x1387101cf6543df732d0b9a5aeab09be44fcbdb5');

        console.log(tradingCards);

        // var result = tradingCards.cards(1);
        // console.log(result); // '0x25434534534'
        // tradingCards.cards(3, function(error, result){
        //     if(!error)
        //         console.log(JSON.stringify(result));
        //     else
        //         console.error(error);
        // });
        var accountInterval = setInterval(function() {
            // Check if account has changed
            if (web3.eth.accounts[0] !== userAccount) {
                userAccount = web3.eth.accounts[0];
                // Call a function to update the UI with the new account
                console.log("have account now do stuff");

                getUnownedCardsCount().then(function(result) {
                    displayUnownedCardsCount(result);
                });

                getCardSetName().then(name => {
                    $("#cardSetDescription").html('CardSet ' + name + ' at ' + tradingCardsAddress);
                });


                $("#cardSetAddress").html(tradingCardsAddress);

                getCardsByOwner(userAccount).then(result => {
                    displayCards(result);
                    return getUniqueCardsCount();
                }).then(result => {
                    console.log('uniqueCount:' + result);
                    $(".uniqueCardCount").text(result);
                });

            }
        }, 3000);


        // onclick event
        $("#buyRandomCard").click(function() {
            buyRandomCard();
        });

        $("#submitCardSetAddress").click(function() {
            const cardSetAddress = $("#cardSetAddress").val();
            localStorage.setItem('cardSetContract', cardSetAddress);
        });


        $("#submitCardSetAddressShow").click(function() {
            $("#cardSetAddressForm").show();
        });

        $("#submitCardSetAddressCancel").click(function() {
            $("#cardSetAddressForm").hide();
        });




        // create filter
        var filter = tradingCards.CardBought({}, function (error, result) {
            if (!error)
                console.log("aaa");
            console.log(result);
            /*
            {
                address: '0x8718986382264244252fc4abd0339eb8d5708727',
                topics: "0x12345678901234567890123456789012", "0x0000000000000000000000000000000000000000000000000000000000000005",
                data: "0x0000000000000000000000000000000000000000000000000000000000000001",
                ...
            }
            */
        });

        // tradingCards.events.NewCard()
        //     .on("data", function(event) {
        //         let data = event.returnValues;
        //         console.log("new card created");
        //         // The current user just received a zombie!
        //         // Do something here to update the UI to show it
        //     }).on("error", console.error);
    }

    function getCardsByOwner(owner) {
        return promisify(tradingCards.getCardsByOwner, owner)
    }

    function getCardSetName() {
        return promisify(tradingCards.name);
    }
    function getUnownedCardsCount() {
        return promisify(tradingCards.getUnownedCardsCount);
    }
    function getUniqueCardsCount() {
        return promisify(tradingCards.getUniqueCardsCount);
    }
    function buyRandomCard() {
        return promisify(tradingCards.buyRandomCard);
    }

    function getCardDetails(id) {
        console.log('getting card details....');
        return promisify(tradingCards.cards, id);
    }

    function displayUnownedCardsCount(count) {
        $("#unownedCardsCount").empty();
        $("#unownedCardsCount").append(`
        <div>
        Hurry! Only ${count} cards left.
        </div>`);
    }

    function displayCards(ids) {
        $("#cards").empty();
        for (id of ids) {
            console.log(id);
            // Look up card details from our contract. Returns a `Card` object
            getCardDetails(id)
                .then(card => {
                    console.log('aa');
                    console.log(card);
                    // Using ES6's "template literals" to inject variables into the HTML.
                    // Append each one to our #card div
                    $("#cards").append(`
<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4 d-flex align-items-stretch">
            <div class="card card-cascade wider mb-4 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal">${card[0]}</h4>
                </div>
                <div class="card-body">

                    <img class="card-img-top" src="images/${card[0]}.jpeg" alt="Card image cap">

                    <ul class="list-unstyled mt-3 mb-4">
                        <li>O.G => 23</li>
                        <li>Coding => 44</li>
                    </ul>
                    <small class="text-muted">${card[1]}/<span class="uniqueCardCount"></span></small>
                </div>
            </div>
        </div>
`);
                });
        }
    }



    window.addEventListener('load', function() {

        console.log("load event.....");
        //web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            console.log("web3 defined");
            // Use Mist/MetaMask's provider
            web3js = new Web3(web3.currentProvider);
        } else {
            // Handle the case where the user doesn't have Metamask installed
            // Probably show them a message prompting them to install Metamask
        }

        // Now you can start your app & access web3 freely:
        startApp()

    })
</script>

</body>
</html>