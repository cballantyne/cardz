
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">

    <meta charset="UTF-8">
    <title>Luna Cards</title>
    <script language="javascript" type="text/javascript" src="js/web3.js-1.0.0-beta.36/web3.min.js"></script>

    <script language="javascript" type="text/javascript" src="tradingcards.abi.js"></script>
    <script language="javascript" type="text/javascript" src="tradingCardShop.abi.js"></script>

</head>

<body>

<div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
    <h5 class="my-0 mr-md-auto font-weight-normal">Luna Cards</h5>
    <nav class="my-2 my-md-0 mr-md-3">
        <a class="p-2 text-dark" href="https://github.com/cballantyne/cardz">Github</a>
        <a class="p-2 text-dark" href="#" id="wtfLink">WTF is this?</a>
    </nav>
</div>

<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <!--<h1 class="display-4">Pricing</h1>-->
    <p class="lead" id="cardSetDescription"></p>

    <p class="lead"></p>

    <p class="lead" id="cardsForSaleCount">

    </p>

    <p class="lead" id="userCardsCount"></p>

    <a href="#" id="buyRandomCard">Buy Random Card</a>
</div>

<div class="container">
    <div id="cards" class="row mb-3 text-center">

        <!-- cards are displayed here -->
    </div>

    <footer class="pt-4 my-md-5 pt-md-5 border-top">
        <div class="row">

            <div class="col-6 col-md">
                <ul class="list-unstyled text-small">
                    <li><a href="#" data-toggle="modal" data-target="#changeCardSetModal">Change CardSet</a></li>
                    <li><a href="#" data-toggle="modal" data-target="#changeCardShopModal">Change CardShop</a></li>
                </ul>
            </div>
            <div class="col-6 col-md">
                <ul class="list-unstyled text-small">
                    <li><a href="#" data-toggle="modal" data-target="#mintCardsModal">Mint Cards</a></li>
                </ul>
            </div>
        </div>
    </footer>
</div>


<!-- Modal -->
<div class="modal fade" id="mintCardsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Mint Cards</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                Name: <input type="text" id="mint_name"><br>
                Instance Count: <input type="text" id="mint_instanceCount">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="mintCardsBtn">Mint Cards</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal ChangeSet -->
<div class="modal fade" id="changeCardSetModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeCardSetModalLabel">Change CardSet</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    CardSet Address: <input type="text" id="cardSetAddress" class="col-lg-10"><br>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="submitCardSetAddressCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitCardSetAddress">Set</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ChangeShop -->
<div class="modal fade" id="changeCardShopModal" tabindex="-1" role="dialog" aria-labelledby="changeCardShopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeCardShopModalLabel">Change CardShop</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    CardShop Address: <input type="text" id="cardShopAddress" class="col-lg-10"><br>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="submitCardShopAddressCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitCardShopAddress">Set</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Transfer -->
<div class="modal fade" id="transferModal" tabindex="-1" role="dialog" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">Transfer Card</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="cardToTransfer"></div>
                <form>
                    To: <input type="text" id="transfer_to" class="col-lg-10"><br>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="transferCardBtn">Transfer Card</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal wtf -->
<div class="modal fade" id="wtfModal" tabindex="-1" role="dialog" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wtfModalLabel">WTF</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Trading cards on Ethereum using ERC721.</p>
                <p>"What happened to you, Dillon? You used to be someone I could trust."</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Gotcha</button>
            </div>
        </div>
    </div>
</div>

<script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

<script>
    // CardShop Ropsten - 0x980b064ef60e93a8f714caa25de182d9c43d4869
    // CardSet Ropsten - 0xf9faa12be3787e4336f8d3018141f6b89a59b38d
    var tradingCards;
    var tradingCardShopInstance;
    var userAccount;
    let tradingCardShopCardsCount;
    let userAccountCardsCount;
    const defaultTradingCardsAddress = '0xf9faa12be3787e4336f8d3018141f6b89a59b38d';

    if (localStorage.getItem('cardSetContract') === null) {
        localStorage.setItem('cardSetContract', defaultTradingCardsAddress);
    }
    if (localStorage.getItem('cardShopContract') === null) {
        localStorage.setItem('cardShopContract', '0x980b064ef60e93a8f714caa25de182d9c43d4869');
    }

    let tradingCardsAddress = localStorage.getItem('cardSetContract');
    let tradingCardShopAddress = localStorage.getItem('cardShopContract');

    console.log(`cardSetAddress:${tradingCardsAddress}`);
    console.log(`cardShopAddress:${tradingCardShopAddress}`);

    function startApp() {
        console.log("starting app...");
        tradingCards = new web3js.eth.Contract(tradingcardsAbi, tradingCardsAddress);
        tradingCardShopInstance = new web3js.eth.Contract(tradingCardShopAbi, tradingCardShopAddress);

        const accountInterval = setInterval(function() {
            // Check if account has changed
            web3js.eth.getAccounts().then(function(accounts) {

                if (accounts[0] !== userAccount) {

                    console.log('got accounts!!!');
                    console.log(accounts[0]);
                    userAccount = accounts[0];
                    displayCardSet(userAccount);
                } else {
                    getBalanceOf(tradingCardShopAddress).then(balance => {
                        if (tradingCardShopCardsCount !== balance) {
                            console.log('shop balance changed so refreshing ui.');
                            displayCardSet(userAccount);
                        }
                    });
                    getBalanceOf(userAccount).then(balance => {
                        if (userAccountCardsCount !== balance) {
                            console.log('user balance changed so refreshing ui.');
                            displayCardSet(userAccount);
                        }
                    });



                }
            });


        }, 3000);


        // onclick event
        $("#buyRandomCard").click(function() {
            buyRandomCard();
        });

        $("#submitCardSetAddress").click(function() {
            const cardSetAddress = $("#cardSetAddress").val();
            localStorage.setItem('cardSetContract', cardSetAddress);
            tradingCardsAddress = cardSetAddress;
            //
            // const tradingCardsContract = web3js.eth.contract(tradingcardsAbi);
            // tradingCards = tradingCardsContract.at(tradingCardsAddress);

            tradingCards = new web3js.eth.Contract(tradingcardsAbi, tradingCardsAddress);

            $("#changeCardSetModal").modal('toggle');
            displayCardSet(userAccount);
        });


        $("#submitCardShopAddress").click(function() {
            const cardShopAddress = $("#cardShopAddress").val();
            localStorage.setItem('cardShopContract', cardShopAddress);
            tradingCardShopAddress = cardShopAddress;

            const tradingCardShopContract = web3js.eth.contract(tradingCardShopAbi);
            tradingCardShopInstance = tradingCardsContract.at(tradingCardShopAddress);

            $("#changeCardShopModal").modal('toggle');
            displayCardSet(userAccount);
        });



        $("#mintCardsBtn").click(function() {
            const name = $("#mint_name").val();
            const instanceCount = $("#mint_instanceCount").val();
            mintCards(name, instanceCount);
        });

        $("#transferCardBtn").click(function() {
            const cardId = $("#transfer_cardId").val();
            const to = $("#transfer_to").val();
            transferCard(cardId, to);
        });

        $('body').on('click', 'a.cardTransferLink', function(event) {
            const cardId = event.target.id.replace("cardTransferLink_","");
            $("#transferModal").modal('toggle');
            $("#cardToTransfer").empty();

            getCardDetails(cardId)
                .then((card) => {
                    $.getJSON( "js/cardset.metadata.json", function( data ) {
                        for (cardMetadata of data.cards) {
                            if (card[0] === cardMetadata.id) {
                                $("#cardToTransfer").append(`
                                <input type="hidden" id="transfer_cardId" value="${cardId}"/>
                                Card: ${cardMetadata.name}</br>`);
                            }
                        }
                    });
                });
        });

        $('body').on('click', 'a#wtfLink', function() {
            $("#wtfModal").modal('toggle');
        });


        // event filters
        // tradingCardShopInstance.events.CardBought({}, function (error, result) {
        //     if (!error) {
        //         console.log(result);
        //         let event = result.args;
        //         console.log(`CardBought with cardId${event.cardId}, owner:${event.owner}`);
        //         displayCardsForSaleCount();
        //         displayCardsForOwner(userAccount);
        //     }
        // });
        //
        // tradingCards.events.CardsMinted({}, function (error, result) {
        //     if (!error) {
        //         console.log(result);
        //         let event = result.args;
        //         console.log(`CardsMinted with name:${event.name}, cardNum:${event.cardNum}, instanceCount:${event.instanceCount}`);
        //         displayCardsForSaleCount();
        //         displayCardsForOwner(userAccount);
        //     } else {
        //
        //         console.log('error on mint.');
        //         console.log(error)
        //     }
        // });

    }

    function displayCardSet(owner) {
        getCardSetName().then(name => {
            $("#cardSetDescription").html('CardSet ' + name + ' at ' + tradingCardsAddress);
        }).catch((err) => {
            console.log('error occurred getting cardset name.');
            console.log(err);
        });

        displayCardsForOwner(owner);
        displayCardsForSaleCount();
    }

    function displayCardsForOwner(owner) {

        getBalanceOf(owner).then((balance) => {
            userAccountCardsCount = balance;
            displayUserCardsCount(userAccountCardsCount);
        });
        getCardsByOwner(owner)
            .then(result => {

                displayCards(result);
                return getUniqueCardsCount();
            })
            .then(result => {
               console.log('uniqueCount:' + result);
               $(".uniqueCardCount").text(result);
               displayCardsMetadata();
            });
    }

    function displayCardsMetadata() {
        // add abilities display
        $.getJSON( "js/cardset.metadata.json", function( data ) {
            for (card of data.cards) {
                $(`.${card.id}_name`).empty();
                $(`.${card.id}_name`).append(`${card.name}`);


                $(`.${card.id}_abilities`).empty();
                if (card.abilities) {
                    for (ability of card.abilities) {
                        $(`.${card.id}_abilities`).append(`<li>${ability.name} = ${ability.level}</li>`);
                    }
                }
            }
        });
    }

    function displayCardsForSaleCount() {
        getBalanceOf(tradingCardShopAddress).then(balance => {
            tradingCardShopCardsCount = balance;
            $("#cardsForSaleCount").empty();
            $("#cardsForSaleCount").append(`
                <div>
                Hurry! Only ${balance} cards left.
                </div>`);
        });
    }
    function displayUserCardsCount(count) {
        $("#userCardsCount").empty();
        $("#userCardsCount").append(`
            You own ${count} cards.
            `);

    }


    function getCardsByOwner(owner) {
        return tradingCards.methods.getCardsByOwner(owner).call()
    }
    function getBalanceOf(owner) {
        return tradingCards.methods.balanceOf(owner).call()
    }

    function getCardSetName() {
        return tradingCards.methods.name().call();
    }
    function getUniqueCardsCount() {
        return tradingCards.methods.getUniqueCardsCount().call();
    }
    function buyRandomCard() {
        console.log(tradingCardsAddress);
        return tradingCardShopInstance.methods.buyRandomCard(tradingCardsAddress).send({from: userAccount});
    }
    function mintCards(name, instanceCount) {
        $("#mintCardsModal").modal('toggle');
        return tradingCards.methods.mintCards(name, instanceCount).send({from: userAccount});
    }

    function transferCard(cardId, to) {
        $("#transferModal").modal('toggle');

        console.log(`from:${userAccount}`);
        console.log(`to:${to}`);
        console.log(`cardId:${cardId}`);
        return tradingCards.methods.transferFrom(userAccount, to, cardId).send({from: userAccount});
    }
    function getCardDetails(id) {
        return tradingCards.methods.cards(id).call();
    }

    function displayCards(ids) {
        $("#cards").empty();
        for (id of ids) {
            const currentId = id;
            // Look up card details from our contract. Returns a `Card` object
            getCardDetails(currentId)
                .then(card => {
                    //console.log(card);
                    // Using ES6's "template literals" to inject variables into the HTML.
                    // Append each one to our #card div
                    $("#cards").append(`
<div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4 d-flex align-items-stretch">
            <div class="card card-cascade wider mb-4 shadow-sm">
                <div class="card-header">
                    <h4 class="my-0 font-weight-normal ${card[0]}_name">${card[0]}</h4>
                </div>
                <div class="card-body">

                    <img class="card-img-top" src="images/${card[0]}.jpeg" alt="Card image cap">

                    <ul class="list-unstyled mt-3 mb-4 ${card[0]}_abilities">

                    </ul>
                    <small class="text-muted">${card[1]} of <span class="uniqueCardCount"></span> (${currentId})</small>


                </div>
                <div class="card-footer text-muted">
                    <a href="#" class="cardTransferLink" id="cardTransferLink_${currentId}">Transfer</a>
                </div>
            </div>
        </div>
`);
                });
        }
    }



    window.addEventListener('load', function() {

        console.log("load event.....");
        //web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:7545"));

        // Checking if Web3 has been injected by the browser (Mist/MetaMask)
        if (typeof web3 !== 'undefined') {
            console.log("web3 defined");
            // Use Mist/MetaMask's provider
            web3js = new Web3(web3.currentProvider);
        } else {
            console.log('metamask not found.');
            // Handle the case where the user doesn't have Metamask installed
            // Probably show them a message prompting them to install Metamask
        }

        // Now you can start your app & access web3 freely:
        startApp()

    })
</script>

</body>
</html>